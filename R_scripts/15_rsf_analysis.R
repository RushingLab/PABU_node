###################################################################################
## Diane Klement
## May 10 2024
##
## Code to analyze the data generated by "14_rsf_spatial.R" script as a GLMM
##
###################################################################################

# Loading necessary packages
library(tidyverse)
library(lme4)
library(AICcmodavg)

# Reset R's brain - removes all previous objects
rm(list=ls())

################################################################################
# Reading in data
d <- readRDS("data/rsf/rsf_data_burn.rds")

################################################################################

# Re-editing data
d$veg_reclass_int <- d$veg_reclass
d$veg_reclass_int1 <- floor(d$veg_reclass_int)
str(d)

# 'veg_reclass' is stored as numeric but should be factors
d$veg_reclass_int1 <- as.factor(d$veg_reclass_int1)
class(d$veg_reclass_int)
levels(d$veg_reclass_int)
str(d)

# burn_reclass storing as a factor
d$burn_reclass <- as.factor(d$burn_reclass)
levels(d$burn_reclass)
d$burn_reclass <- factor(d$burn_reclass, levels=c('7', '3', '6', '2', '4'))
str(d)

d$year_two_three <- d$Year2_3
d$year_zero_one <- d$Year0_1
d$year_three_four <- d$Year3_4
d$year_one_two <- d$Year1_2
################################################################################

# Creating a GLMM

# Run a null model
mNull <- glmer(Used ~ 1 + (1|TagId), data = d, family = 'binomial')
# Call model output
summary(mNull)
mNull

################################################################################

# Running univariate models

# New models for burn
#model with burn type
mBurn <- glmer(Used ~ burn_reclass + (1|TagId), data = d, family = 'binomial')
summary(mBurn)

# Model for burn type
#including all dummy codes except for the unburned (to use as the comparison factor)
mBurn2<- glmer(Used ~  Year0_1 + Year1_2 + Year2_3 + Year3_4
              + (1|TagId), data = d, family = 'binomial')
summary(mBurn2)


mBurn3<- glm(Used ~  Year0_1 + Year1_2 + Year2_3 + Year3_4
               , data = d, family = binomial(link="logit"))
summary(mBurn3)
broom::tidy(mBurn3)

# Model for veg type
# Getting rid of any veg columns with NA
d1 <- d[!is.na(d$veg_reclass_int1), ]
#model with veg type
mVeg <- glmer(Used ~ veg_reclass_int1 + (1|TagId), data = d1, family = 'binomial')
summary(mVeg)

# Model for veg type
#including all dummy codes except for most common one - Maritime Grassland
mVegc<- glmer(Used ~  Fresh_Tidal_Marsh + Salt_Tidal_Marsh + Tidal_Wooded_Swamp + Mar_Forest + Ponds_Lakes + Interdune_Wetland + Beach
         + (1|TagId), data = d1, family = 'binomial')
summary(mVegc)


################################################################################

#Occurrence probability of time since burn
predData.burn <- data.frame(Burn = c('Unburned', 'Year0_1', 'Year1_2', 'Year2_3', 'Year3_4'))
pred.burn <- predict(mBurn2, newdata = predData.burn, se.fit = TRUE)
predData.burn$p <- plogis(pred.burn$fit) # back transform to probability scale
predData.burn$lower <- plogis(pred.burn$fit - pred.burn$se.fit)
predData.burn$upper <- plogis(pred.burn$fit + pred.burn$se.fit)

ggplot() +
  geom_col(data = predData.burn, aes(x = Burn, y = p), fill = "grey60") +
  geom_errorbar(data = predData.burn, aes(x = Burn, ymin = lower, ymax = upper),
                width = 0.1) +
  scale_y_continuous("Probability of USE") +
  scale_x_discrete("Time Since Burn")