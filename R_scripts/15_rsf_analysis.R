###################################################################################
## Diane Klement
## May 10 2024
##
## Code to analyze the data generated by "14_rsf_spatial.R" script as a GLMM
##
###################################################################################

# Loading necessary packages
library(tidyverse)
library(lme4)
library(AICcmodavg)

# Reset R's brain - removes all previous objects
rm(list=ls())

################################################################################
# Reading in data
d <- readRDS("data/rsf/rsf_data.rds")

################################################################################

# Re-editing data
d$veg_reclass_int <- d$veg_reclass
d$veg_reclass_int1 <- floor(d$veg_reclass_int)
str(d)

# 'veg_reclass' is stored as numeric but should be factors
d$veg_reclass_int1 <- as.factor(d$veg_reclass_int1)
class(d$veg_reclass_int)
levels(d$veg_reclass_int)
str(d)

################################################################################

# Creating a GLMM

# Run a null model
mNull <- glmer(Used ~ 1 + (1|TagId), data = d, family = 'binomial')
# Call model output
summary(mNull)
mNull

################################################################################

# Running univariate models

# Model for veg type
# Getting rid of any veg columns with NA
d1 <- d[!is.na(d$veg_reclass_int1), ]
#model with veg type
mVeg <- glmer(Used ~ veg_reclass_int1 + (1|TagId), data = d1, family = 'binomial')
summary(mVeg)

# Model for veg type
#including all dummy codes except for most common one - Maritime Grassland
mVegc<- glmer(Used ~  Fresh_Tidal_Marsh + Salt_Tidal_Marsh + Tidal_Wooded_Swamp + Mar_Forest + Ponds_Lakes + Interdune_Wetland + Beach
         + (1|TagId), data = d1, family = 'binomial')
summary(mVegc)

# Model for years since burn
# Getting rid of any burn columns with NA
d2 <- d1[!is.na(d1$lssibtime_1), ]
# doing the same except for the standardized column
d3 <- d1[!is.na(d1$lssibtime_1_std), ]

#model with years from burn without standardization
mBurn <- glmer(Used ~ lssibtime_1 + (1|TagId), data = d2, family = 'binomial')
summary(mBurn)


#model with years from burn with standardization
mBurnSd <- glmer(Used ~ lssibtime_1_std + (1|TagId), data = d3, family = 'binomial')
summary(mBurnSd)

################################################################################

# Model Selection

aictab(list(mNull, mVeg, mVegc, mBurn, mBurnSd),
       modnames = c('mNull', 'mVeg', 'mVegc', 'mBurn', 'mBurnSd'),
       sort = T)

################################################################################

##likelihood ratio test
mTop <- mNull
mNull_glm <- glm(Used~ 1, data = d, family = 'binomial')
# LRT using anova()
anova(mNull, mNull_glm, test = 'Chisq')

mTop <- mFeeder
library(lme4)

# Random effects and CI estimates
(fixed <- fixef(mTop))
(fixed.1 <- fixef(mTop1))

parms <- names(fixed) 
(fixedCI <- confint(mTop, level = 0.95, parm=parms, 
                    method='profile'))  # Change method to 'Wald' for speed
# Pull the coefficient estimates from the summary table
loTable <- as.data.frame(coef(summary(mTop)))[,1:2]
# Add the CIs
(loTable <- cbind(loTable, fixedCI))
(oTable <- exp(loTable))
#export table
write.csv(oTable, 'C:/Users/dklem/Documents/Classes/WILD 8321/TopModel_OddsRatio_PABURSF1.csv')

#coefficient plots
# Load ggplot2
library(ggplot2)

# Plot function
pTable <- loTable
pTable$params <- factor(rownames(loTable), levels = rownames(loTable))
names(pTable)[3:4] <- c('ll', 'ul')

# W/o intercept
windows()
qplot(params, Estimate, ymin=ll, ymax=ul, data=pTable[-1,],
      geom='pointrange') + 
  geom_hline(aes(yintercept = 0)) +
  coord_flip() +
  theme_bw()

# For random effects modes and CI estimates
(cV <- ranef(mTop, condVar=T))

d2 <- read.csv('C:/Users/dklem/Documents/Classes/WILD 8321/RSFdata_std_3rdOrder_Kernel_rand10x.csv')
knitr::kable(table(d2[d2$Used==1, 'ID'], d2[d2$Used==1, 'Year']), caption = "Table 3: Data counts by ID by Year")
# Load the lattice (plotting) library
library(lattice)

# Random effects modes and CI estimates
windows()
dotplot(cV)

1- exp(-0.539223)
1- exp(-0.277)
mFeeder
1- exp(-0.003731)
mFeeder

